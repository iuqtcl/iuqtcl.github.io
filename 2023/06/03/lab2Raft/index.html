<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"iuqtcl.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="implementStudents’ Guide to Raft助教的实验指导 经常出错的细节例 The ultimate guide to Raft is in Figure 2 of the Raft paper. 指实现上一个字都不能和 figure 2 冲突. election timeout 在收到 current leader 的 RPC, 或者给 candidate 投票时(不是收到">
<meta property="og:type" content="article">
<meta property="og:title" content="lab 2 Raft">
<meta property="og:url" content="https://iuqtcl.github.io/2023/06/03/lab2Raft/index.html">
<meta property="og:site_name" content="Cyber Ghost">
<meta property="og:description" content="implementStudents’ Guide to Raft助教的实验指导 经常出错的细节例 The ultimate guide to Raft is in Figure 2 of the Raft paper. 指实现上一个字都不能和 figure 2 冲突. election timeout 在收到 current leader 的 RPC, 或者给 candidate 投票时(不是收到">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-06-03T03:19:50.444Z">
<meta property="article:modified_time" content="2023-06-03T03:20:25.685Z">
<meta property="article:author" content="iuqtcl">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://iuqtcl.github.io/2023/06/03/lab2Raft/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>lab 2 Raft | Cyber Ghost</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Cyber Ghost</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">（确信）</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://iuqtcl.github.io/2023/06/03/lab2Raft/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ee2.jpg">
      <meta itemprop="name" content="iuqtcl">
      <meta itemprop="description" content="人暂时没remake，blog已经re了">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cyber Ghost">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          lab 2 Raft
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-06-03 11:19:50 / 修改时间：11:20:25" itemprop="dateCreated datePublished" datetime="2023-06-03T11:19:50+08:00">2023-06-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mit6-824/" itemprop="url" rel="index"><span itemprop="name">mit6.824</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="implement"><a href="#implement" class="headerlink" title="implement"></a>implement</h2><h3 id="Students’-Guide-to-Raft"><a href="#Students’-Guide-to-Raft" class="headerlink" title="Students’ Guide to Raft"></a>Students’ Guide to Raft</h3><p><a target="_blank" rel="noopener" href="https://thesquareplanet.com/blog/students-guide-to-raft/">助教的实验指导</a></p>
<h4 id="经常出错的细节例"><a href="#经常出错的细节例" class="headerlink" title="经常出错的细节例"></a>经常出错的细节例</h4><ul>
<li>The ultimate guide to Raft is in Figure 2 of the Raft paper. 指实现上一个字都不能和 figure 2 冲突.</li>
<li>election timeout 在收到 current leader 的 RPC, 或者给 candidate 投票时(不是收到投票请求)重置</li>
<li>与需要添加 log 的 AppendEntries RPC 一样, follower 收到心跳包后应该对当前任期与日志条目是否与 leader 一致进行检查, (心跳包只是 log 为空的 AppendEntries RPC) follower 接受 RPC 即是暗示 leader 其日志与 leader 一致.</li>
<li>如果 follower 拥有 leader 发送的所有条目, 则必须保留 leader 发送条目之后的元素. 若冲突位置的条目没有 leader 的新, 则删除后面所有 log. 因为收到的 AppendEntries RPC 可能是过时的.</li>
</ul>
<h4 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h4><p>bug 的主要来源是 livelocks, incorrect or incomplete RPC handlers, failure to follow The Rules, and term confusion.</p>
<h5 id="Livelocks-注意事项"><a href="#Livelocks-注意事项" class="headerlink" title="Livelocks 注意事项"></a><a target="_blank" rel="noopener" href="https://thesquareplanet.com/blog/students-guide-to-raft/#livelocks">Livelocks</a> 注意事项</h5><p>系统仍在工作, 但是反复无效工作. 例: 没有选举出 leader; 选举出的 leader 立即退位.</p>
<ul>
<li>确保在正确的时候重置 election timer: 只在以下情况重置 (1) 收到现任 leader 的RPC (如果过时则不重置); (2) 发起选举; (3) <strong>投票给 candidate</strong>, 而不是收到投票请求 (在网络不稳定时第三条很重要, 因为大部分服务器的 log 不同, 只有少量的服务器可以获得一个服务器的选票; 这样做可以使拥有更新 log 的服务器不被打扰, 更可能被选为 leader)</li>
<li>candidate 正在进行选举时, 如果 election timer 到点, 则 candidate 开始新选举. (前一场选举可能有 RPC 延迟或丢失)</li>
<li>更新 term 时记得重置 votefor</li>
</ul>
<h5 id="Incorrect-RPC-handlers-注意事项"><a href="#Incorrect-RPC-handlers-注意事项" class="headerlink" title="Incorrect RPC handlers 注意事项"></a><a target="_blank" rel="noopener" href="https://thesquareplanet.com/blog/students-guide-to-raft/#incorrect-rpc-handlers">Incorrect RPC handlers</a> 注意事项</h5><ul>
<li><h6 id="如果收到的-prevlogindex-超过当前日志的长度-像处理任期冲突一样处理它"><a href="#如果收到的-prevlogindex-超过当前日志的长度-像处理任期冲突一样处理它" class="headerlink" title="如果收到的 prevlogindex 超过当前日志的长度, 像处理任期冲突一样处理它."></a>如果收到的 prevlogindex 超过当前日志的长度, 像处理任期冲突一样处理它.</h6></li>
<li>即使发送的消息不包含 log, 也要检查 prevlogindex 的任期信息.</li>
<li>在 <code>If leaderCommit &gt; commitIndex, set commitIndex = min(leaderCommit, index of last new entry)</code> 中, min 是必要的. 并且它需要用最后一个<strong>新</strong>条目来计算. 且不能简单地 apply 所有 lastapply 到 commitindex. 因为如果 leadercommit 超出了 leader 发送的条目( follower 本身的 log 比 leader 长 ), 可能会 apply 不正确的条目. </li>
<li>完全按照5.4节中实现 “up-to-date log”.</li>
</ul>
<h5 id="Failure-to-follow-The-Rules"><a href="#Failure-to-follow-The-Rules" class="headerlink" title="Failure to follow The Rules"></a><a target="_blank" rel="noopener" href="https://thesquareplanet.com/blog/students-guide-to-raft/#failure-to-follow-the-rules">Failure to follow The Rules</a></h5><ul>
<li>及时检查是否 commitIndex &gt; lastIndex ,是则apply</li>
<li>如果AppendEntries RPC 被拒绝,但不是因为log冲突时, 则该 log 过时, 不进行任何修改</li>
<li>leader不能commit之前term的条目</li>
<li>通常, nextIndex &#x3D; matchIndex + 1但两者用途不同. nextIndex是leader共享给follower前缀的乐观<strong>猜测</strong>, 只有在出现负面回应时才倒退. matchIndex 是为了安全性而设置, 是保守的测量. 只有follower回应是成功添加时,才更新matchIndex.</li>
</ul>
<h3 id="Part-2A-leader-election"><a href="#Part-2A-leader-election" class="headerlink" title="Part 2A: leader election"></a>Part 2A: leader election</h3><p>实现领导人选举和心跳</p>
<h4 id="Hints"><a href="#Hints" class="headerlink" title="Hints"></a>Hints</h4><ul>
<li><p>run <code>go test -run 2A</code> to test</p>
</li>
<li><p>看<strong>论文 Figure 2</strong>. 注意收发请求投票的 RPC，和选举、状态相关的规则</p>
</li>
<li><p>添加 Figure 2 中的 state 到 struct Raft. 定义保存 log entry 信息的结构体</p>
</li>
<li><p>填写 <code>RequestVoteArgs</code> and <code>RequestVoteReply</code>. 在 <code>Make()</code> 中建立 goroutine 检测是否要选举了(发送 RequesetVote). 完成 <code>RequestVote()</code> .</p>
</li>
<li><p>实现 heartbeats：定义一个 <code>AppendEntries</code> RPC struct，leader 周期性发送。</p>
<p><code>AppendEntries</code> RPC handler method - 重置 election timeout</p>
<p>leader 每秒发送心跳不超过十次</p>
</li>
<li><p>注意 election timeout 的随机性，防止所有 nodes 只给自己投票</p>
</li>
<li><p>原 leader crash 之后需要在 5 s 内选出新的</p>
</li>
<li><p>go rand</p>
</li>
<li><p><strong>周期性或延迟执行</strong>的实现：整个 goroutine 然后 time.Sleep() . 查看<code>Make()</code>创建的<code>ticker()</code>，不要用 go 的  <code>time.Timer</code> or <code>time.Ticker</code></p>
</li>
<li><p>rf.Kill() 用于永久停止某个节点。 You may want to do this in all loops, to avoid having dead Raft instances print confusing messages. 没懂什么意思（不使用Kill在断开时打印信息，term会显示为0）</p>
</li>
</ul>
<h4 id="实现记录"><a href="#实现记录" class="headerlink" title="实现记录"></a>实现记录</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create a new Raft server instance:</span></span><br><span class="line">rf := Make(peers, me, persister, applyCh)</span><br><span class="line"><span class="comment">//peer：RPC识别码 </span></span><br></pre></td></tr></table></figure>

<ol>
<li>为 raft 结构体添加了 term, state (string类型，似乎使用 State 类型更好，以后试试), electiontimeout（每次随机更新）, tickerstart（甚至拼错了，似乎不用写进结构体，直接放在 ticker()里就好）. 简单判断了收到投票请求后的处理。下一步，修改 ticker() 同时完善 election timeout 的更新</li>
<li>设定 election timeout 为 300 - 600 ms ，心跳包暂定为 150 ms 一个。</li>
<li><code>ticker()</code>使用 for 循环间隔检查上一次开始计时到当前的时长是否超过 election timeout，若超过，则 rf.state 切换为 candidate，向其他节点发送投票申请。使用了 for 循环启动 goroutine 来实现并行发送。注意循环到自身时 continue 跳过。</li>
<li>debug 结论 节点状态需要及时转换，包括选举结束时， candidate 要么变成 follower，要么变成 leader; 心跳包不止用于重置 follower 的 election timout，并且将<strong>过时的 leader（其他 sever 和自身）&#x2F;同时选举的 candidate</strong> 转换为 follower。</li>
<li>最大收获可能是学到了一种闭包的使用以及go的各种并发原语。。。</li>
<li>加 - race 测试，狠狠 race，在 sentHeartBeat() 和 ticker() 中每次检测循环条件时添加了锁。（之前没有 else 分支的可能需要添加 else 来 unlock）注意不要将发送 rpc 请求的部分 lock，否则可能会导致线程阻塞。</li>
</ol>
<h3 id="Part-2B-log"><a href="#Part-2B-log" class="headerlink" title="Part 2B: log"></a>Part 2B: log</h3><p>实现 leader 和 follower 添加新 log entries</p>
<p>start(command) 由应用层向 raft 传输命令. </p>
<p>当每个 peers 成功提交 log entries 时, 应该通过 applyCh 向 Make() 发送一条 ApplyMsg. 在 ApplyMsg 的参数中, <code>commandvalid</code> 表示 applymsg 包含了一条新提交的 log entry.(false则表示发送了其他类型的消息, 比如快照)</p>
<h4 id="Hints-1"><a href="#Hints-1" class="headerlink" title="Hints"></a>Hints</h4><ul>
<li>先实现 <code>Start()</code>，然后通过 AppendEntries RPC 发送新的 committed entry。在每个 peer 的 applyCh 上发送每个新提交的条目.</li>
<li>实现 election restriction (5.4.1 in the paper).</li>
<li>达成共识失败的原因可能是在 leader 活着的时候重复选举。Look for bugs in election timer management, or not sending out heartbeats immediately after winning an election.</li>
<li>使用 condition variables 或者每次循环 sleep 一段时间.</li>
<li>需要时查看 <code>test_test.go</code> 了解需求.</li>
</ul>
<h4 id="实现-ver-1"><a href="#实现-ver-1" class="headerlink" title="实现 ver.1"></a>实现 ver.1</h4><p>写了两遍, 重构核心函数一次, 所以以下不一定是对的..</p>
<ol>
<li><p>根据 figure 2 为 Raft 添加了 <code>commitIndex</code>(最后 commit 的 log 目录,即 log 数量为 commitindex+1), <code>lastApplied</code> 用于记录当前节点记录 log 的提交和执行情况;<code>log</code> 用于记录所有的 log 内容; <code>nextINdex</code>, <code>matchIndex</code> 用于 leader 记录每个节点的更新状况. 在 make() 中初始化. (实现持久化后需要修改)</p>
</li>
<li><p>修改了投票条件. 需要保存每个 log 的 term, 因此为 Raft 添加了 <code>logterm []int</code>.  </p>
<ul>
<li>candidate 的 currentterm 不小于 follower 的 term, (若 candidate term 大于 follower term, 则先更新 follower term 并将 votefor 重置为 -1)</li>
<li>candidate 的 lastlogterm 大于 follower 的 lastlogterm, 或相等而 candidate 更长</li>
<li>votefor 为 -1</li>
</ul>
</li>
<li><p>raft 对应用层的反馈 ApplyMsg, 通过 <code>ApplyCh</code> 实现. 向 raft 中添加了 ApplyCh, 在 CommitRequest() 中, 当返回请求结果为 true 的 server 数量过半时, 向 applyCh 中传入 <code>ApplyMsg</code>, 并且向已经更新好的 server 发送 ApplyMsg 命令, 如果未更新好, 则等待至更新完成.</p>
</li>
<li><p>向<code>AppendEntriesApply</code> 中加入 </p>
<ul>
<li>xterm         冲突位置的 follower 任期 </li>
<li>xindex        xterm 任期中第一条 log 的索引</li>
<li>xlen             follower 的 log 过短, 需要再向 entries 中添加的 log 数量</li>
</ul>
<p><strong>AppendEntry 检测冲突</strong>时首先检测 follower 的 commitIndex 是否小于 args.PreLogIndex, 若小于, 返回 success &#x3D; false, xlen &#x3D; prelogindex - commitindex; 若 follower 最后一条 log 的任期或目录与 args 中 pre 信息不符, 则填入 xterm, xindex 并返回; 若未检测到冲突, 则向 rf.log 中写入新 entries, 并更新 rf.commitindex </p>
</li>
<li><p><code>CommitRequest</code> 中添加<strong>对冲突的处理</strong>, 分三种情况, follower 的 log 过短; 冲突条目对应的 follower term 在 leader 中存在&#x2F; 不存在; 更新 args 中的 <code>prelogindex</code>, <code>prelogterm</code>, <code>entries</code>, **<code>entriesterm</code> **以及 <code>rf.nextindex[sever]</code></p>
</li>
</ol>
<p>一些问题</p>
<p>rf.matchindex目前仅在 commit 成功后更新, 有什么用我尚且蒙古.</p>
<h4 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h4><p>冲突处理</p>
<p>向<strong>AE reply</strong>中添加条目</p>
<ul>
<li>xTerm	term of conflictiong entry</li>
<li>xIndex    index of first entry of xTerm</li>
<li>xLen        log 槽位数, 没有则返回 -1</li>
</ul>
<ol>
<li>follower 记录过短，冲突位置没有条目，xTerm &#x3D; -1, xLen &#x3D; 除了当前项还空白的槽位数，下一次直接发送到 follower 的第一个空槽位</li>
<li>follower 返回的xterm在leader中有记录，leader将对于该follower的nextindex设置为本地xterm后第一条log的地方</li>
<li>follower 返回的xterm在leader中无记录，leader将nextindex设置为xindex</li>
</ol>
<p><strong>AppendEntry</strong></p>
<ul>
<li>冲突对于接收方有两种情况<ol>
<li>自身记录过短, rf.currentIndex &lt; prelogindex.</li>
<li>对应index中entry的term与prelogterm不符.</li>
</ol>
</li>
<li>不冲突, 修改follower的log</li>
<li>判断无需修改的情况, 记为 outofdate, 返回时丢弃</li>
<li>更新 follower 的 commitIndex</li>
</ul>
<p><strong>TryAppendEntry()</strong></p>
<p>核心函数, 收到应用层命令后主动复制命令和 heartbeat 中都调用该方法, 向 follower 发送 RPC, 并处理 reply, 若遇冲突, 先调用 ConflictProcess() 再递归调用自身.</p>
<p>细节: 多次发送 RPC 时不要复用 reply.</p>
<p><strong>Apply的时机</strong></p>
<p>使用channel,一旦commitIndex更新,则触发rf.commitIndex&gt;rf.applyIndex的检查</p>
<p><strong>heartbeat</strong></p>
<p>发送一条log为空的AppendEntry, 其中 PreLogIndex &#x3D; rf.currentIndex.</p>
<p>如果follower的最后一条log与leader一致,则无需更新log,仅检查commit更新.</p>
<p><strong>debug记录</strong></p>
<ol>
<li>处理killed的服务器:获取rpc的返回值,失败则重发rpc.对于sendHeartBeat,如果失败则不做处理;对于AppendEntry和VoteRequest,如果失败则立即重发.修改后可通过2B前四个test(无冲突).</li>
<li>rf.currentIndex计算错误.改为rf.currentIndex &#x3D; args.prelogindex + len(args.Entries).</li>
<li>增加 leader 对 commit 的更新, 维持常驻线程,检测 matchindex <code>LeaderCheckCommit()</code></li>
</ol>
<p>当前问题: killed的server不知为何会自己开启一轮选举;heartbeat需要和replicateEntries合并;replicateEntries中的细节问题.包括每次发送的log目录和重发逻辑.</p>
<ol start="4">
<li>test4, leader 断开后选不出新的leader, log相同的follower互相拒绝,怀疑 leaderelection问题. 修改 leaderelection, 未连接的server不计数,candidate超时可以开始下一次选举. 发现在leaderelection中未设置候选人commitindex信息,因此导致选举错误.</li>
<li>follower断开后, leader尝试发log后会卡住,无法给别的发log. 解决:向heartbeat中增加了冲突处理, 新增了<code>TryAppendEntry()</code>,合并了ReplicateEntries()和HeartBeat()的处理.</li>
<li>增加对过时Entries的判断,若过时,则直接丢弃</li>
<li>某些情况下选不出新leader.根据论文中对<strong>more up-to-date</strong>的定义,先比较最后一条log的term,大者新;若一样,比较log长度.修改requestvote()中投票条件.</li>
<li>TestConcurrentStarts2B和最后一个test运行到某处后只剩leader不断发heartbeat.<strong>[原因:commit到apply的channel加锁了,去锁后健康]</strong> debug几小时才发现, 头大.</li>
<li>将不冲突的心跳记为outofdate,导致matchindex不能更新. 解决: 为outofdate加一个logindex与matchindex比大小的判断.</li>
</ol>
<h3 id="Part-2C-persistence"><a href="#Part-2C-persistence" class="headerlink" title="Part 2C: persistence"></a>Part 2C: persistence</h3><p>将 raft state 写入 persister 对象，每次 reboot 时 make() 读取 persister。包括了保存和读取。</p>
<h4 id="怎样读取和保存"><a href="#怎样读取和保存" class="headerlink" title="怎样读取和保存"></a>怎样读取和保存</h4><p>完成<code>persist()</code>(存)和<code>readPersist()</code>(取).</p>
<p>使用<code>labgob</code>编码, 将信息编码为bytes串传递到Persister对象中.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Persister <span class="keyword">struct</span> &#123;</span><br><span class="line">	mu        sync.Mutex</span><br><span class="line">	raftstate []<span class="type">byte</span></span><br><span class="line">	snapshot  []<span class="type">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="何时读取-x2F-保存持久化"><a href="#何时读取-x2F-保存持久化" class="headerlink" title="何时读取&#x2F;保存持久化"></a>何时读取&#x2F;保存持久化</h4><p>在更改 persistent state 时, 保存.</p>
<ol>
<li>candidate发起选举时, 收到选举请求term更新&#x2F;投票时</li>
<li>leader收到用户层apply, follower接受append修改log</li>
</ol>
<p>在 raft.Make() 中读取.</p>
<h4 id="持久化的内容"><a href="#持久化的内容" class="headerlink" title="持久化的内容"></a>持久化的内容</h4><p>raftstate :</p>
<ul>
<li>currentTerm</li>
<li>voteFor</li>
<li>log[]</li>
</ul>
<p>snapshot实现2D时再写.</p>
<p><strong>debug记录</strong></p>
<ol>
<li>basic persistence: server间未达成共识.可能原因: 读取时未根据恢复server的其他记录.**在readPersist()**中使用了len(rf.log),2D时需修改.</li>
<li>test: more persistence. 出现term交错问题. 更低的 term 被添加成功.term神秘回退.原因:persist()中手误给currentTerm存了currentIndex</li>
</ol>
<h3 id="Part-2D-log-compaction"><a href="#Part-2D-log-compaction" class="headerlink" title="Part 2D: log compaction"></a>Part 2D: log compaction</h3><p>论文 section7</p>
<p>在长期运行的服务器上, 储存快照并丢弃之前的条目.</p>
<p>hints:</p>
<ul>
<li>在单个InstallSnapshot RPC中发送整个快照,不需要实现论文中拆分快照的偏移机制.</li>
<li></li>
</ul>
<h4 id="快照更新与持久化"><a href="#快照更新与持久化" class="headerlink" title="快照更新与持久化"></a>快照更新与持久化</h4><p>实现 raft.snapshot(). snapshot 是一个被应用主动唤起的方法. 功能是制作返回快照, 并且trim掉尽量多的log.持久化新的快照和log.</p>
<p>index参数代表snapshot中反映的最高log</p>
<p><strong>leader发送消息更新follower</strong></p>
<p>实现<code>InstallSnapshot</code> RPC</p>
<p>(?)根据已经记录的follower的matchindex分情况处理</p>
<h4 id="快照储存的内容"><a href="#快照储存的内容" class="headerlink" title="快照储存的内容"></a>快照储存的内容</h4><p>每个server独立储存,只覆盖committed entries</p>
<h4 id="使用已储存的快照"><a href="#使用已储存的快照" class="headerlink" title="使用已储存的快照"></a>使用已储存的快照</h4><ol>
<li><p>服务器重启时, 读取persistence中的快照和log.</p>
</li>
<li><p>当follower更新过于慢, 需要的log已经被leader丢弃时, leader向follower发送快照.</p>
</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ApplyMsg <span class="keyword">struct</span> &#123;</span><br><span class="line">	CommandValid <span class="type">bool</span></span><br><span class="line">	Command      <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	CommandIndex <span class="type">int</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// For 2D:</span></span><br><span class="line">	SnapshotValid <span class="type">bool</span></span><br><span class="line">	Snapshot      []<span class="type">byte</span></span><br><span class="line">	SnapshotTerm  <span class="type">int</span></span><br><span class="line">	SnapshotIndex <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="raft-snapshot-实现"><a href="#raft-snapshot-实现" class="headerlink" title="raft.snapshot()实现"></a>raft.snapshot()实现</h4><p>snapshot是每个server独立运行的,只有当follower落后过多时才</p>
<ol>
<li>将log中[x,lastincludeindex]删除,剩余log在数组切片中的索引是<code>index - LastIncludeIndex</code></li>
<li>更新log[0]中的snapshotinfo</li>
<li>更新rf.snapshot</li>
<li>持久化</li>
</ol>
<h4 id="persist-和readPersist-的修改"><a href="#persist-和readPersist-的修改" class="headerlink" title="persist()和readPersist()的修改"></a>persist()和readPersist()的修改</h4><p>persist()将save时的nil项改为snapshotstate, snapshotstate由rf.snapshot编码直接生成.</p>
<p>readPersist()增加判断压缩的数据类型.rf.currentIndex改为lastincludedindex+len(rf.log) - 1</p>
<p>问题: log不能再用currentIndex下标取</p>
<h4 id="InstallSnapshot"><a href="#InstallSnapshot" class="headerlink" title="InstallSnapshot()"></a>InstallSnapshot()</h4><p>不需要实现分块发送RPC,因此将论文中Args结构体中删去offset和done.</p>
<h4 id="debug记录"><a href="#debug记录" class="headerlink" title="debug记录"></a>debug记录</h4><ol>
<li>试图installsnapshot之后一个follower一直试图leader election. 解决: 锁套锁了.</li>
<li>数组越界.发现当要发送的log是切片中的第一条时, preTerm取了log[0].Term&#x3D;0. (snapshot的信息存在了log[0].command中),改为log[0].Term也同步更新.</li>
<li>install snapshot 后, apply entry时由于lastApplied小于, 数组越界.解决:install snapshot后, 应该立即提交 snapshot并修改apply index.</li>
<li>log[] 在某处data race了.</li>
</ol>
<p>锁排查: </p>
<p>AppendEntry() 函数级锁</p>
<p>RequestVote() 函数级锁</p>
<p>InstallSnapshot() 向<code>rf.applyCh</code>发送snapshot时未锁,其余锁.检查出一个返回前未unlock.为保险将生成msg也放入锁中.</p>
<p>Start() 函数级锁</p>
<p>ReplicateEntries 由于发送请求和条件变量分成了三个锁,但除发送RPC都锁.</p>
<p>… 发现TryInstallSnapshot() 请求之后的后半段完全没锁</p>
<ol start="5">
<li>installsnapshot() 中当需要保留一部分log时数组向上越界.原因 索引未减去原来的snapshotindex.</li>
<li>conflictprocess()中数组越界,猜测由于索引变动appendentry的返回值reply.xindex有问题.修改reply.XIndex &#x3D; i+snapshotindex, i 为log索引.</li>
<li>复制log时若遇到logindex&lt;snapshotindex,则放弃复制.-&gt;尝试复制snapshot.(?)</li>
<li>某个follower在某次添加完log后死了. 怀疑 AppendEntry()中 rf.commitCh 阻塞. 修改AppendEntry()中的锁.</li>
<li>snapshot decode error. persist &#x2F; read persist 出错. snapshot 持久化时不需要编码,,</li>
<li>snapshotinfo 导致的编码错误. 由于rf.log[0].term中已经储存了lastincludedterm,因此删除snapshotinfo结构,在rf.log[0].command中储存lastincludeindex. 修改后 2D crash test 通过,2C及之前无snapshot的部分无法通过.</li>
<li>snapshot 数组越界. 原因 先修改了log再读原term. </li>
<li>readPersist时将commit和apply都设为snapshot</li>
<li>无尽conflict,原因: 查找同一任期log时将log[0]也算进去了, 然后自动尝试并没有用的installsnapshot.(两者snapshot相同)</li>
<li>服务器可能发送过时的snapshot,忽略即可.</li>
<li>神秘datarace:原因,发送RPC时使用的args.Entries使用了错误的切片复制方式.取了地址.</li>
</ol>
<p>go切片的最佳复制方式</p>
<p>newNums :&#x3D; make([]int, len(nums))</p>
<p>copy(newNums,nums)</p>
<h2 id="Paper"><a href="#Paper" class="headerlink" title="Paper"></a>Paper</h2><h3 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h3><p>管理复制日志的<strong>一致性算法</strong>（状态机转移）</p>
<p>关键模块</p>
<ul>
<li>领导人选举：旧 leader 宕机选举新 leader</li>
<li>日志复制</li>
<li>安全性</li>
</ul>
<p>特性</p>
<ul>
<li><strong>强领导者</strong>：例如⽇志条⽬只从领导者发送给其他的服务器，简化了对复制⽇志的管理并好理解。</li>
<li><strong>领导选举</strong>：用随机计时器来选举领导者，基于心跳机制实现，用于解决冲突。</li>
<li><strong>成员关系调整</strong>：使得集群在成员变换的时候依然可以继续⼯作。</li>
</ul>
<h3 id="复制状态机"><a href="#复制状态机" class="headerlink" title="复制状态机"></a>复制状态机</h3><p>通常基于复制日志实现</p>
<h3 id="Raft-流程"><a href="#Raft-流程" class="headerlink" title="Raft 流程"></a>Raft 流程</h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/514512060">论文翻译</a>, <a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf">raft(extend)论文</a>, <a target="_blank" rel="noopener" href="http://thesecretlivesofdata.com/raft/">raft演示动画</a>,<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/notes/raft_diagram.pdf">各函数交互示意图</a></p>
<p>每个 node 有三种可能状态：follower, candidate, leader</p>
<p>选举一个 <strong>Leader</strong> ，响应所有客户端请求。</p>
<p>节点间通信使用两种 RPC</p>
<ul>
<li>请求投票（Request Vote）：选举时</li>
<li>追加条目（Append Entries）：复制日志和心跳</li>
</ul>
<h4 id="leader-election"><a href="#leader-election" class="headerlink" title="leader election"></a>leader election</h4><ol>
<li><p>当一个 node 不再收到 leader 的消息**(election timeout)** -&gt; 成为candidate -&gt; 开启新任期（给自己的 term 加一)，并给自己投票</p>
</li>
<li><p>请求其他 nodes 的投票 - 接收其他 nodes 的回应</p>
</li>
</ol>
<p>​		若得票超过半数 -&gt; 成为 leader</p>
<ol start="3">
<li>接收到请求的节点如果在 candidate 的这个任期没有投过票（term 小于 candidate 的 term），那么它会投票，更新 term，切换状态为 follower ，并重置 election timeout</li>
</ol>
<p>election timeout: <strong>random</strong> between 150 ms ~ 300 ms（在 heartbeats 发送间隔小于 150 ms 的情况下）</p>
<p>heartbeat timeout: leader 每隔 heartbeat timeout 向所有节点发送心跳包，节点收到后会回应</p>
<p><strong>term (任期) :</strong></p>
<ul>
<li>每开始一次选举，为一个新的任期</li>
<li>当前任期号比其他节点小，更新自己的任期号</li>
<li>Leader 或 Candidate 发现自己任期号过期，立即转为 Follower</li>
<li>收到过期的任期号请求，拒绝请求。</li>
</ul>
<p><strong>split vote</strong> 两个节点同时成为 candidate：若没有节点得票过半，则自然流动到下一个任期。</p>
<h4 id="log-replication"><a href="#log-replication" class="headerlink" title="log replication"></a>log replication</h4><h5 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h5><p>一条日志包括<strong>任期号</strong>，一条<strong>指令</strong>，一个整数<strong>索引</strong></p>
<p>根据论文，AppendEntries RPC 的结构为</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> AppendEnrtriesArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">	Term     <span class="type">int</span></span><br><span class="line">	LeaderId <span class="type">int</span></span><br><span class="line">    PrevLogIndex <span class="type">int</span></span><br><span class="line">    PrevLogTerm  <span class="type">int</span></span><br><span class="line">    []Entries	<span class="comment">//empty for heartbeat</span></span><br><span class="line">    LeaderCommit <span class="type">int</span>	<span class="comment">//应用指令到状态机的索引</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> AppendEnrtriesReply <span class="keyword">struct</span> &#123;</span><br><span class="line">	Term    <span class="type">int</span>	</span><br><span class="line">	Success <span class="type">bool</span>		<span class="comment">//if contain entry matching prevLogIndex and preLogTerm </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h5><ol>
<li>leader 收到 client 请求，将请求 append entries 复制发送到所有 nodes，让其追加日志</li>
<li>leader 等待至大部分节点回应（<strong>安全复制</strong>），leader 根据 entry 修改自己的数据，Leader 应用该指令到状态机并返回结果给客户端（通过下次 AE RPC，包括心跳，附加 <code>commitIndex</code>来通知 follower），回应 client</li>
</ol>
<h5 id="日志一致性"><a href="#日志一致性" class="headerlink" title="日志一致性"></a>日志一致性</h5><ul>
<li>在不同的日志中的两个条目拥有<strong>相同的索引和任期号</strong>，那么他们<strong>存储了相同的指令</strong>。</li>
<li>在不同的日志中的两个条目拥有<strong>相同的索引和任期号</strong>，那么他们<strong>之前的所有日志条目也全部相同</strong>。</li>
</ul>
<p><strong>追加日志的一致性检查</strong>：每次新条目 AE RPC 给 Follower，如果上一条索引任期不一致，则拒收新条目。所以<strong>一旦 AE RPC 返回成功，说明 Follower 所有日志和 Leader 相同</strong>。</p>
<h5 id="日志不一致的情况"><a href="#日志不一致的情况" class="headerlink" title="日志不一致的情况"></a>日志不一致的情况</h5><p>leader 未完全复制日志时宕机会使日志不一致。Follower 可能没有新Leader 有的条目，也可能有新 Leader 没有的条目。</p>
<p><strong>Leader 强制 Follower 复制自己的日志，即覆盖 Follower 中所有冲突日志</strong>。</p>
<p>Leader 找到最后和 Follower 一致的地方，删除 Follower 之后的冲突日志，发送自己的日志附加给 Follower。这些操作<strong>在 AE RPCs 一致性检查时完成</strong>：</p>
<ul>
<li>Leader 对每个 Follower 维护下一个需发送的条目索引<code>nextIndex</code>，在刚上任时初始化为最新日志索引加一（图 7 中 11）。</li>
<li><strong>Follower 日志不一致则拒绝 AE PRC</strong>，Leader <strong>减小</strong><code>nextIndex</code><strong>重试直到成功</strong>，Follower 删除冲突日志并追加 Leader 日志。日志即保持一致。<br>这里可以优化，Follower 拒绝时返回冲突任期号的最早地址，Leader 下次就可以越过同任期号的冲突。但是此优化不一定有必要，因为实际很少发生。</li>
</ul>
<h4 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h4><ul>
<li>需要保证 follower 包含所有已提交日志条目。-&gt; 方法：<strong>增加选举限制</strong></li>
</ul>
<p>选举时投票人比较<strong>最后一条日志的索引值和任期号</strong>，投票人会拒绝日志没有自己新的投票请求。</p>
<p>任期号不同，则任期号大的新；任期号相同，索引值大的比较新</p>
<ul>
<li>某日志被复制到多数节点也不代表它被提交。 -&gt; <strong>增加日志提交条件</strong></li>
</ul>
<p><strong>Leader 在当前任期至少有一条日志被提交</strong></p>
<p>新上任的 Leader 在接受客户写入命令前先提交一个 no-op（空命令），携带自己任期号的日志复制到多数节点</p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><ol>
<li><a target="_blank" rel="noopener" href="https://thesquareplanet.com/blog/students-guide-to-raft/">助教的实验指导</a></li>
<li><a target="_blank" rel="noopener" href="http://thesecretlivesofdata.com/raft/">raft演示动画</a></li>
<li><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf">raft(extend)论文</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/514512060">论文翻译</a></li>
<li><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/labs/lab-raft.html">课程实验指导</a> 包括锁, debug 等指导</li>
<li>20年lecture5, 讲了各种并发原语，很有帮助</li>
<li>20年lecture6.7 raft 讲解</li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/05/18/rcore-learning/" rel="prev" title="rcore实验文档阅读 简短记录">
      <i class="fa fa-chevron-left"></i> rcore实验文档阅读 简短记录
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#implement"><span class="nav-number">1.</span> <span class="nav-text">implement</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Students%E2%80%99-Guide-to-Raft"><span class="nav-number">1.1.</span> <span class="nav-text">Students’ Guide to Raft</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%8F%E5%B8%B8%E5%87%BA%E9%94%99%E7%9A%84%E7%BB%86%E8%8A%82%E4%BE%8B"><span class="nav-number">1.1.1.</span> <span class="nav-text">经常出错的细节例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#debug"><span class="nav-number">1.1.2.</span> <span class="nav-text">debug</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Livelocks-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">Livelocks 注意事项</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Incorrect-RPC-handlers-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">Incorrect RPC handlers 注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E6%94%B6%E5%88%B0%E7%9A%84-prevlogindex-%E8%B6%85%E8%BF%87%E5%BD%93%E5%89%8D%E6%97%A5%E5%BF%97%E7%9A%84%E9%95%BF%E5%BA%A6-%E5%83%8F%E5%A4%84%E7%90%86%E4%BB%BB%E6%9C%9F%E5%86%B2%E7%AA%81%E4%B8%80%E6%A0%B7%E5%A4%84%E7%90%86%E5%AE%83"><span class="nav-number">1.1.2.2.1.</span> <span class="nav-text">如果收到的 prevlogindex 超过当前日志的长度, 像处理任期冲突一样处理它.</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Failure-to-follow-The-Rules"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">Failure to follow The Rules</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Part-2A-leader-election"><span class="nav-number">1.2.</span> <span class="nav-text">Part 2A: leader election</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Hints"><span class="nav-number">1.2.1.</span> <span class="nav-text">Hints</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E8%AE%B0%E5%BD%95"><span class="nav-number">1.2.2.</span> <span class="nav-text">实现记录</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Part-2B-log"><span class="nav-number">1.3.</span> <span class="nav-text">Part 2B: log</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Hints-1"><span class="nav-number">1.3.1.</span> <span class="nav-text">Hints</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-ver-1"><span class="nav-number">1.3.2.</span> <span class="nav-text">实现 ver.1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9"><span class="nav-number">1.3.3.</span> <span class="nav-text">修改</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Part-2C-persistence"><span class="nav-number">1.4.</span> <span class="nav-text">Part 2C: persistence</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%8E%E6%A0%B7%E8%AF%BB%E5%8F%96%E5%92%8C%E4%BF%9D%E5%AD%98"><span class="nav-number">1.4.1.</span> <span class="nav-text">怎样读取和保存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%95%E6%97%B6%E8%AF%BB%E5%8F%96-x2F-%E4%BF%9D%E5%AD%98%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">1.4.2.</span> <span class="nav-text">何时读取&#x2F;保存持久化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E7%9A%84%E5%86%85%E5%AE%B9"><span class="nav-number">1.4.3.</span> <span class="nav-text">持久化的内容</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Part-2D-log-compaction"><span class="nav-number">1.5.</span> <span class="nav-text">Part 2D: log compaction</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BF%AB%E7%85%A7%E6%9B%B4%E6%96%B0%E4%B8%8E%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">1.5.1.</span> <span class="nav-text">快照更新与持久化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BF%AB%E7%85%A7%E5%82%A8%E5%AD%98%E7%9A%84%E5%86%85%E5%AE%B9"><span class="nav-number">1.5.2.</span> <span class="nav-text">快照储存的内容</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%B7%B2%E5%82%A8%E5%AD%98%E7%9A%84%E5%BF%AB%E7%85%A7"><span class="nav-number">1.5.3.</span> <span class="nav-text">使用已储存的快照</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#raft-snapshot-%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.5.4.</span> <span class="nav-text">raft.snapshot()实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#persist-%E5%92%8CreadPersist-%E7%9A%84%E4%BF%AE%E6%94%B9"><span class="nav-number">1.5.5.</span> <span class="nav-text">persist()和readPersist()的修改</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#InstallSnapshot"><span class="nav-number">1.5.6.</span> <span class="nav-text">InstallSnapshot()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#debug%E8%AE%B0%E5%BD%95"><span class="nav-number">1.5.7.</span> <span class="nav-text">debug记录</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Paper"><span class="nav-number">2.</span> <span class="nav-text">Paper</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Abstract"><span class="nav-number">2.1.</span> <span class="nav-text">Abstract</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E5%88%B6%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="nav-number">2.2.</span> <span class="nav-text">复制状态机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Raft-%E6%B5%81%E7%A8%8B"><span class="nav-number">2.3.</span> <span class="nav-text">Raft 流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#leader-election"><span class="nav-number">2.3.1.</span> <span class="nav-text">leader election</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#log-replication"><span class="nav-number">2.3.2.</span> <span class="nav-text">log replication</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%93%E6%9E%84"><span class="nav-number">2.3.2.1.</span> <span class="nav-text">结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B"><span class="nav-number">2.3.2.2.</span> <span class="nav-text">流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">2.3.2.3.</span> <span class="nav-text">日志一致性</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">2.3.2.4.</span> <span class="nav-text">日志不一致的情况</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%80%A7"><span class="nav-number">2.3.3.</span> <span class="nav-text">安全性</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#refer"><span class="nav-number">3.</span> <span class="nav-text">refer</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="iuqtcl"
      src="/images/ee2.jpg">
  <p class="site-author-name" itemprop="name">iuqtcl</p>
  <div class="site-description" itemprop="description">人暂时没remake，blog已经re了</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/iuqtcl" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;iuqtcl" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">iuqtcl</span>
</div>
<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>
-->

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
